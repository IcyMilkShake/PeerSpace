<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post - Forum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="themes.css">
    <link rel="stylesheet" href="navigation.css">
    <style>
        .mentions-suggestions {
            border: 1px solid var(--border-color);
            background-color: var(--bg-elevated);
            color: var(--text-primary);
            position: absolute;
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
        }

        .mentions-suggestions div {
            padding: 8px;
            cursor: pointer;
        }

        .mentions-suggestions div:hover {
            background-color: var(--bg-hover);
        }
    </style>
</head>
<body class="min-h-screen">
    <nav class="navigation-bar">
      <div class="nav-container">
        <a href="/" class="nav-item">
          <i class="fas fa-home" style="color: var(--notification-info-bg);"></i>
          <span class="nav-text">Home</span>
        </a>
        <a href="#" class="nav-item">
          <i class="fas fa-user" style="color: var(--notification-info-bg);"></i>
          <span class="nav-text">Profile (havent coded)</span>
        </a>
      </div>
    </nav>
    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm sm:max-w-md p-4 space-y-3 z-[100]">
        <!-- Notifications will be dynamically added here -->
    </div>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- Post Container -->
        <div id="post-container" class="space-y-6">
            <!-- Post will be loaded here -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-16 hidden">
            <div class="text-gray-400 text-6xl mb-4">üìù</div>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">Post not found</h3>
            <p class="text-gray-500">This post may have been deleted or the link is incorrect.</p>
        </div>
    </main>

    <script>
        let currentUser = null;
        
        async function checkAuth() {
            try {
                const response = await fetch('/api/user', {
                    credentials: 'include'
                });
                if (response.ok) {
                    currentUser = await response.json();
                } else {
                    currentUser = null;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                currentUser = null;
            }
        }

        function getPostIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        async function loadPost() {
            const postId = getPostIdFromUrl();
            if (!postId) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch(`/api/posts/${postId}`);
                if (response.ok) {
                    const post = await response.json();
                    renderPost(post);
                } else {
                    document.getElementById('empty-state').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Failed to load post:', error);
                document.getElementById('empty-state').classList.remove('hidden');
            }
        }

        function countAllComments(comments) {
            let count = comments.length;
            for (const comment of comments) {
                if (comment.replies && comment.replies.length > 0) {
                    count += countAllComments(comment.replies);
                }
            }
            return count;
        }

        function renderPost(post) {
            const container = document.getElementById('post-container');
            container.innerHTML = '';
            const article = document.createElement('article');
            article.className = 'rounded-lg shadow-md p-6';
            
            const postHeader = document.createElement('div');
            postHeader.className = 'flex items-center space-x-3 mb-4';

            const authorProfileLink = document.createElement('a');
            authorProfileLink.href = `/profile.html?id=${post.author.id}`;
            authorProfileLink.className = "flex items-center space-x-3 group flex-grow"; 

            const postProfileImg = createProfileImage(post.author.photo, post.author.displayName, "w-10 h-10");
            authorProfileLink.appendChild(postProfileImg);
            
            const postHeaderInfo = document.createElement('div');
            postHeaderInfo.innerHTML = `
                <div class="font-medium text-gray-800 group-hover:underline">${escapeHtml(post.author.displayName)}</div>
                <div class="text-sm text-gray-500">${formatDate(post.createdAt)}</div>
            `;
            authorProfileLink.appendChild(postHeaderInfo);
            postHeader.appendChild(authorProfileLink);

            const postContentElement = document.createElement('div');
            const postTitleHtml = `<h2 class="text-xl font-bold mb-3">${escapeHtml(post.title)}</h2>`;
            postContentElement.innerHTML = postTitleHtml;

            const postTextParagraph = document.createElement('p');
            postTextParagraph.className = "text-gray-700 mb-4 whitespace-pre-wrap";
            postTextParagraph.innerHTML = escapeHtml(post.content, true);
            postContentElement.appendChild(postTextParagraph);

            const commentsSection = document.createElement('div');
            commentsSection.className = 'border-t pt-4';
            
            const commentsHeader = document.createElement('h3');
            commentsHeader.className = 'font-semibold mb-3';
            const totalComments = countAllComments(post.comments);
            commentsHeader.textContent = `Comments (${totalComments})`;
            commentsSection.appendChild(commentsHeader);

            if (currentUser) {
                const commentFormContainer = document.createElement('div');
                commentFormContainer.className = 'mb-4';
                const textarea = document.createElement('textarea');
                textarea.id = `comment-textarea-${post.id}`;
                textarea.placeholder = "Add a comment...";
                textarea.rows = 2;
                textarea.maxLength = 1000;
                textarea.className = "w-full px-3 py-2 rounded-lg resize-none focus:outline-none focus:ring-2";
                textarea.onkeyup = () => handleMention(textarea);

                const charCountSpan = document.createElement('span');
                charCountSpan.className = 'text-sm text-gray-500';
                charCountSpan.textContent = '0 / 1000';

                const button = document.createElement('button');
                button.onclick = () => addCommentOrReply(post.id);
                button.className = "button-submit-comment mt-2 px-4 py-2 rounded-lg font-medium transition-colors";
                button.textContent = "Add Comment";

                textarea.addEventListener('input', () => {
                    const currentLength = textarea.value.length;
                    const maxLength = textarea.maxLength;
                    charCountSpan.textContent = `${currentLength} / ${maxLength}`;
                    if (currentLength >= maxLength) {
                        charCountSpan.classList.add('text-red-500');
                    } else {
                        charCountSpan.classList.remove('text-red-500');
                    }
                });
                
                const bottomDiv = document.createElement('div');
                bottomDiv.className = 'flex justify-between items-center';
                bottomDiv.appendChild(charCountSpan);
                bottomDiv.appendChild(button);

                commentFormContainer.appendChild(textarea);
                commentFormContainer.appendChild(bottomDiv);
                commentsSection.appendChild(commentFormContainer);
            }

            const commentsContainer = document.createElement('div');
            commentsContainer.className = 'space-y-3';
            renderCommentTree(buildCommentTree(post.comments, null), commentsContainer, post.id, 0, post.comments);
            commentsSection.appendChild(commentsContainer);

            article.appendChild(postHeader);
            article.appendChild(postContentElement);
            article.appendChild(commentsSection);
            container.appendChild(article);

            const hash = window.location.hash;
            if (hash) {
                const element = document.querySelector(hash);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth' });
                    element.style.backgroundColor = 'var(--accent-color-subtle)';
                    setTimeout(() => {
                        element.style.backgroundColor = '';
                    }, 3000);
                }
            }
        }

        function buildCommentTree(comments, parentId) {
            return comments
                .filter(comment => comment.parentComment === parentId)
                .map(comment => ({
                    ...comment,
                    replies: buildCommentTree(comments, comment._id)
                }));
        }

        function renderCommentTree(comments, parentElement, postId, depth, postComments) {
            comments.forEach(comment => {
                const commentWrapper = createCommentElement(comment, postId, depth, postComments);
                parentElement.appendChild(commentWrapper);

                if (comment.replies && comment.replies.length > 0) {
                    const nestedContainer = commentWrapper.querySelector('.comment-wrapper');
                    renderCommentTree(comment.replies, nestedContainer, postId, depth + 1, postComments);
                }
            });
        }

        function createCommentElement(comment, postId, depth, postComments) {
            const commentWrapper = document.createElement('div');
            commentWrapper.id = `comment-${comment._id}`;
            commentWrapper.className = `comment-wrapper mt-3 pl-${depth * 2}`;

            const commentDiv = document.createElement('div');
            commentDiv.className = 'flex items-start space-x-3 bg-gray-50 p-3 rounded-lg shadow-sm';

            const commentBody = document.createElement('div');
            commentBody.className = 'flex-1';

            const commentAuthorProfileLink = document.createElement('a');
            commentAuthorProfileLink.href = `/profile.html?id=${comment.author._id}`;
            commentAuthorProfileLink.className = "shrink-0 group";

            const commentProfileImg = createProfileImage(comment.author.profilePicture ? comment.author.profilePicture.path : (comment.author.photo || '/default-profile.png'), comment.author.displayName, "w-8 h-8");
            commentAuthorProfileLink.appendChild(commentProfileImg);
            commentDiv.appendChild(commentAuthorProfileLink);

            const commentAuthorNameLink = document.createElement('a');
            commentAuthorNameLink.href = `/profile.html?id=${comment.author._id}`;
            commentAuthorNameLink.className = "font-medium text-gray-800 hover:underline";
            commentAuthorNameLink.textContent = escapeHtml(comment.author.displayName);

            const commentHeader = document.createElement('div');
            commentHeader.className = 'flex items-center space-x-2 mb-1';
            commentHeader.appendChild(commentAuthorNameLink);

            const commentTimestamp = document.createElement('span');
            commentTimestamp.className = "text-sm text-gray-500";
            commentTimestamp.textContent = formatDate(comment.createdAt);
            commentHeader.appendChild(commentTimestamp);
            commentBody.appendChild(commentHeader);

            if (comment.parentComment) {
                const allComments = postComments || [];
                const parentComment = allComments.find(c => c._id === comment.parentComment);
                if (parentComment) {
                    const replyingToText = document.createElement('p');
                    replyingToText.className = 'text-xs text-gray-500 mb-1';
                    replyingToText.innerHTML = `
                            Replying to: 
                            <a href="/profile.html?id=${parentComment.author._id}" class="text-blue-600 hover:underline font-medium">
                                @${escapeHtml(parentComment.author.username)}
                            </a>
                        `;
                    commentBody.appendChild(replyingToText);
                }
            }

            const commentText = document.createElement('p');
            commentText.className = "text-gray-700 whitespace-pre-wrap";
            commentText.innerHTML = escapeHtml(comment.content, true);
            commentBody.appendChild(commentText);

            const commentActionsDiv = document.createElement('div');
            commentActionsDiv.className = 'comment-actions flex items-center space-x-3 text-xs text-gray-500 mt-2';

            if (currentUser) {
                const replyButton = document.createElement('button');
                replyButton.className = 'hover:text-blue-600 font-medium';
                replyButton.textContent = 'Reply';
                replyButton.onclick = () => toggleReplyForm(comment._id, postId);
                commentActionsDiv.appendChild(replyButton);
            }
            commentBody.appendChild(commentActionsDiv);

            const replyFormContainerId = `reply-form-container-${comment._id}`;
            const replyFormContainer = document.createElement('div');
            replyFormContainer.id = replyFormContainerId;
            replyFormContainer.className = 'reply-form hidden mt-2';
            commentBody.appendChild(replyFormContainer);

            commentDiv.appendChild(commentBody);
            commentWrapper.appendChild(commentDiv);

            return commentWrapper;
        }
        
        function createProfileImage(photoUrl, displayName, size = "w-10 h-10", textClass = "text-sm", borderClass = "") {
            const container = document.createElement('div');
            container.className = `profile-img ${size} ${borderClass} rounded-full flex items-center justify-center overflow-hidden`;
            container.style.backgroundColor = 'var(--input-bg)';
            
            if (borderClass && borderClass.includes('border')) { 
                container.style.borderColor = 'var(--border-color)';
            }
            
            if (photoUrl && photoUrl.trim() && photoUrl !== '/default-profile.png') {
                const img = document.createElement('img');
                img.className = 'w-full h-full object-cover'; 
                img.alt = displayName || 'Profile';
                
                img.onerror = function() {
                    container.innerHTML = `<span class="profile-initials ${textClass} font-semibold" style="color: var(--text-secondary);">${getInitials(displayName)}</span>`;
                };
                
                img.src = photoUrl + '?t=' + Date.now();
                container.appendChild(img);
            } else {
                container.innerHTML = `<span class="profile-initials ${textClass} font-semibold" style="color: var(--text-secondary);">${getInitials(displayName)}</span>`;
            }
            
            return container;
        }

        function getInitials(displayName) {
            if (!displayName) return '?';
            return displayName.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' at ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function escapeHtml(text, allowLinks = false) {
            let escapedText = text.replace(/[&<>"']/g, function (match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });

            if (allowLinks) {
                const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
                escapedText = escapedText.replace(urlRegex, function(url) {
                    let fullUrl = url;
                    if (!url.match(/^[a-zA-Z]+:\/\//)) {
                        fullUrl = 'http://' + url;
                    }
                    const safeHref = fullUrl.replace(/[&<>"']/g, function (match) {
                        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
                    });
                    return `<a href="${safeHref}" target="_blank" rel="noopener noreferrer">${url}</a>`;
                });

                const mentionRegex = /@(\w+)/g;
                escapedText = escapedText.replace(mentionRegex, function(match, username) {
                    return `<a href="/profile.html?username=${username}" class="mention-link">${match}</a>`;
                });
            }
            return escapedText;
        }

        function toggleReplyForm(commentId, postId) {
            const containerId = `reply-form-container-${commentId}`;
            const container = document.getElementById(containerId);
            if (!container) return;

            const existingForm = container.querySelector('textarea');
            if (existingForm) {
                container.classList.toggle('hidden');
                if (!container.classList.contains('hidden')) {
                    container.querySelector('textarea').focus();
                }
            } else {
                container.innerHTML = `
                    <textarea id="reply-textarea-${commentId}" placeholder="Write a reply..." rows="2" maxlength="1000"
                              class="w-full px-3 py-2 text-sm rounded-lg resize-none focus:outline-none focus:ring-1"></textarea> 
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-xs text-gray-500">0 / 1000</span>
                        <div class="flex justify-end space-x-2">
                            <button onclick="document.getElementById('${containerId}').classList.add('hidden');" 
                                    class="button-cancel-reply px-3 py-1 text-xs rounded-md">Cancel</button>
                            <button onclick="addCommentOrReply('${postId}', '${commentId}')" 
                                    class="button-submit-reply px-3 py-1 text-xs rounded-md">Reply</button>
                        </div>
                    </div>
                `;
                container.classList.remove('hidden');
                const textarea = container.querySelector('textarea');
                const charCountSpan = container.querySelector('span');
                textarea.addEventListener('input', () => {
                    const currentLength = textarea.value.length;
                    const maxLength = textarea.maxLength;
                    charCountSpan.textContent = `${currentLength} / ${maxLength}`;
                    if (currentLength >= maxLength) {
                        charCountSpan.classList.add('text-red-500');
                    } else {
                        charCountSpan.classList.remove('text-red-500');
                    }
                });
                textarea.focus();
            }
        }

        async function addCommentOrReply(postId, parentCommentId = null) {
            const textareaId = parentCommentId ? `reply-textarea-${parentCommentId}` : `comment-textarea-${postId}`;
            const textarea = document.getElementById(textareaId);
            if (!textarea) {
                console.error("Textarea not found:", textareaId);
                return;
            }
            const content = textarea.value.trim();

            if (!content) return;

            try {
                let url, body;
                if (parentCommentId) {
                    url = `/api/comments/${parentCommentId}/replies`;
                    body = JSON.stringify({ content });
                } else {
                    url = `/api/posts/${postId}/comments`;
                    body = JSON.stringify({ content });
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: body
                });

                if (response.ok) {
                    const newComment = await response.json();
                    
                    const postRes = await fetch(`/api/posts/${postId}`);
                    const post = await postRes.json();
                    const allComments = post.comments;

                    const postContainer = document.getElementById('post-container');
                    const commentsHeader = postContainer.querySelector('h3.font-semibold');
                    const totalComments = countAllComments(buildCommentTree(allComments, null));
                    commentsHeader.textContent = `Comments (${totalComments + 1})`;

                    if (parentCommentId) {
                        const parentCommentWrapper = document.getElementById(`comment-${parentCommentId}`);
                        const depth = (parentCommentWrapper.className.match(/pl-(\d+)/)?.[1] || 0) / 2 + 1;
                        const newCommentElement = createCommentElement(newComment, postId, depth, allComments);
                        parentCommentWrapper.appendChild(newCommentElement);
                    } else {
                        const commentsContainer = postContainer.querySelector('.space-y-3');
                        const newCommentElement = createCommentElement(newComment, postId, 0, allComments);
                        commentsContainer.appendChild(newCommentElement);
                    }

                    textarea.value = '';
                    if (parentCommentId) {
                        const replyFormContainer = document.getElementById(`reply-form-container-${parentCommentId}`);
                        if (replyFormContainer) {
                            replyFormContainer.classList.add('hidden');
                            replyFormContainer.innerHTML = '';
                        }
                    }

                } else {
                    const errorData = await response.json();
                    showNotification(`Failed to add ${parentCommentId ? 'reply' : 'comment'}: ${errorData.error || 'Server error'}`, 'error');
                }
            } catch (error) {
                console.error(`Failed to add ${parentCommentId ? 'reply' : 'comment'}:`, error);
                showNotification(`An error occurred while adding ${parentCommentId ? 'reply' : 'comment'}. Please try again.`, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadPost();
        });
    </script>
</body>
</html>
