<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Forum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="theme-loader.js"></script> <!-- THEME LOADER -->
    <link rel="stylesheet" href="themes.css"> <!-- THEME STYLES -->
    <style>
        /* Settings page specific styles */
        /* Most base styles (body, nav, cards, modals) are now in themes.css */

        /* Main page title "Settings" */
        main > h1.text-3xl { /* More specific selector if needed */
            color: var(--text-primary);
        }
        
        /* .setting-card and its internal elements (h2, p) are styled by themes.css */
        /* Radio button theme selection styling is now in themes.css */
        /* Placeholder Toggle Switches styling is now in themes.css */

        /* Profile image styling for nav (.profile-img, .profile-initials) is in themes.css */
        /* User profile modal in nav (#user-profile-modal-settings) is styled by themes.css */
        
        /* Ensure Tailwind classes like `bg-white` on .setting-card
           are effectively themed via themes.css.
           For example, .setting-card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        */

        /* Fallback for nav h1 if its color isn't set by themes.css general nav h1 rule */
        nav .text-2xl.font-bold {
            color: var(--text-primary);
        }

        /* Fallback for text colors within setting cards if not covered by general rules */
        .setting-card .text-gray-600 { /* e.g., paragraph text */
            color: var(--text-secondary);
        }
        .setting-card .text-gray-700 { /* e.g., toggle labels if not themed by more specific rules */
            color: var(--text-primary);
        }

    </style>
</head>
<body class="min-h-screen">
    <!-- Navigation -->
    <nav class="shadow-md border-b"> <!-- bg-white was not here, but ensuring it's not -->
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <a href="/" class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-lg">F</span>
                    </div>
                    <h1 class="text-2xl font-bold">Forum</h1>
                </a>
                <div id="auth-section-settings">
                    <!-- Auth status will be rendered here by JS -->
                     <a href="/" class="text-blue-600 hover:text-blue-700">Back to Forum</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- User Profile Modal (for logged-in user nav on this page) -->
    <div id="user-profile-modal-settings" class="hidden fixed top-16 right-4 rounded-lg shadow-lg p-4 border z-50 w-64">
        <div class="flex items-center space-x-3 mb-3 pb-2 border-b"> <!-- Added pb-2 and border-b for consistency -->
            <div id="modal-profile-img-container-settings" class="profile-img w-10 h-10 rounded-full border-2">
                <!-- Profile image will be inserted here by JS -->
            </div>
            <div>
                <div id="modal-user-name-settings" class="font-medium text-sm"></div>
                <div id="modal-user-email-settings" class="text-xs"></div>
            </div>
        </div>
        <a id="view-my-profile-link-settings" href="#"> 
            <!-- JS adds .profile-menu-item class -->
            View My Profile
        </a>
        <a href="settings.html" id="profile-menu-settings-settings" class="profile-menu-item">
            <svg class="w-5 h-5 mr-2 inline" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066 2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            Settings
        </a>
        <hr class="my-1" style="border-top-color: var(--border-color);">
        <button id="logout-btn-settings"> 
            <!-- JS adds .profile-menu-item class -->
            Sign Out
        </button>
    </div>

    <!-- Main Settings Content -->
    <main class="max-w-2xl mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">Settings</h1>

        <!-- Appearance Settings -->
        <section id="appearance-settings" class="setting-card shadow-md rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Appearance</h2>
            <p class="text-sm text-gray-600 mb-1">Choose your preferred theme.</p>
            <div class="space-y-3">
                <div>
                    <input type="radio" id="theme-light" name="theme" value="light" class="sr-only">
                    <label for="theme-light" class="flex items-center cursor-pointer p-3 border rounded-lg hover:bg-gray-50 transition-colors">
                        <span class="w-5 h-5 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center">
                            <span class="radio-dot w-2.5 h-2.5 bg-blue-500 rounded-full hidden"></span>
                        </span>
                        Light Mode
                    </label>
                </div>
                <div>
                    <input type="radio" id="theme-dark" name="theme" value="dark" class="sr-only">
                    <label for="theme-dark" class="flex items-center cursor-pointer p-3 border rounded-lg hover:bg-gray-50 transition-colors">
                         <span class="w-5 h-5 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center">
                            <span class="radio-dot w-2.5 h-2.5 bg-blue-500 rounded-full hidden"></span>
                        </span>
                        Dark Mode
                    </label>
                </div>
                <div>
                    <input type="radio" id="theme-midnight" name="theme" value="midnight" class="sr-only">
                    <label for="theme-midnight" class="flex items-center cursor-pointer p-3 border rounded-lg hover:bg-gray-50 transition-colors">
                         <span class="w-5 h-5 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center">
                            <span class="radio-dot w-2.5 h-2.5 bg-blue-500 rounded-full hidden"></span>
                        </span>
                        Midnight Mode
                    </label>
                </div>
            </div>
        </section>

        <!-- Placeholder Settings -->
        <section id="placeholder-settings" class="setting-card shadow-md rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Future Settings (Placeholders)</h2>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <label for="notification-toggle" class="text-gray-700">Enable Email Notifications</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="notification-toggle" id="notification-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="notification-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer toggle-bg"></label>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <label for="privacy-toggle" class="text-gray-700">Make Profile Private</label>
                     <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="privacy-toggle" id="privacy-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="privacy-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer toggle-bg"></label>
                    </div>
                </div>
                 <div class="flex justify-between items-center">
                    <label for="another-toggle" class="text-gray-700">Another Future Setting</label>
                     <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="another-toggle" id="another-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="another-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer toggle-bg"></label>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // --- Theme Management ---
        function applyTheme(theme) {
            document.documentElement.className = 'theme-' + theme;
            localStorage.setItem('forumTheme', theme);

            // Update radio buttons
            const radioButtons = document.querySelectorAll('input[name="theme"]');
            radioButtons.forEach(radio => {
                radio.checked = (radio.value === theme);
                const dot = radio.nextElementSibling.querySelector('.radio-dot');
                if (dot) {
                    dot.classList.toggle('hidden', radio.value !== theme);
                }
                // Style the label itself
                radio.nextElementSibling.classList.toggle('border-blue-500', radio.value === theme);
                radio.nextElementSibling.classList.toggle('bg-blue-50', radio.value === theme);


            });
             // Update toggle switch styles based on theme
            updateToggleStyles(theme);
        }
        
        function updateToggleStyles(theme) {
            const isDark = theme === 'dark' || theme === 'midnight';
            document.querySelectorAll('.toggle-checkbox').forEach(checkbox => {
                const label = checkbox.nextElementSibling; // The toggle-bg label
                if (isDark) {
                    label.style.backgroundColor = checkbox.checked ? 'var(--button-bg)' : 'var(--input-bg)'; // Use theme variables
                    checkbox.style.borderColor = 'var(--input-border)';
                    checkbox.style.backgroundColor = 'var(--text-primary)'; // Toggle circle color
                } else { // Light theme
                    label.style.backgroundColor = checkbox.checked ? '#3B82F6' : '#CBD5E0'; // Tailwind blue-500 and gray-400
                    checkbox.style.borderColor = '#a0aec0'; // gray-500
                    checkbox.style.backgroundColor = 'white';
                }
            });
        }


        function loadTheme() {
            const preferredTheme = localStorage.getItem('forumTheme') || 'dark'; // Default to dark
            applyTheme(preferredTheme);
            return preferredTheme;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const currentTheme = loadTheme();

            const themeRadios = document.querySelectorAll('input[name="theme"]');
            themeRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    applyTheme(event.target.value);
                });
            });
             // Initial and on-change toggle styling
            document.querySelectorAll('.toggle-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => updateToggleStyles(localStorage.getItem('forumTheme') || 'dark'));
            });
            updateToggleStyles(currentTheme); // Initial call

            // Placeholder toggles - just for looks, no actual functionality
            document.querySelectorAll('.toggle-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (event) => {
                    const label = event.target.nextElementSibling;
                    if (event.target.checked) {
                        label.style.backgroundColor = (localStorage.getItem('forumTheme') === 'dark' || localStorage.getItem('forumTheme') === 'midnight') ? 'var(--button-bg)' : '#3B82F6';
                    } else {
                        label.style.backgroundColor = (localStorage.getItem('forumTheme') === 'dark' || localStorage.getItem('forumTheme') === 'midnight') ? 'var(--input-bg)' : '#CBD5E0';
                    }
                });
            });

            checkAuthStatusForSettingsPage();
        });

        // --- Auth & Nav specific to settings.html (similar to profile.html) ---
        let currentLoggedInUserConfig = null;

        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
        }

        function createProfileImageElementForSettings(photoUrl, name, sizeClasses = "w-10 h-10", textClasses = "text-xl") {
            const container = document.createElement('div');
            container.className = `profile-img ${sizeClasses} rounded-full bg-gray-300 flex items-center justify-center overflow-hidden`;
            
            if (photoUrl && photoUrl.trim() && photoUrl !== '/default-profile.png') {
                const img = document.createElement('img');
                img.className = 'w-full h-full object-cover';
                img.alt = name || 'Profile';
                img.onerror = function() {
                    container.innerHTML = `<span class="profile-initials ${textClasses} font-semibold" style="color: var(--text-primary);">${getInitials(name)}</span>`;
                };
                img.src = photoUrl + '?t=' + Date.now();
                container.appendChild(img);
            } else {
                container.innerHTML = `<span class="profile-initials ${textClasses} font-semibold" style="color: var(--text-primary);">${getInitials(name)}</span>`;
            }
            return container;
        }

        async function checkAuthStatusForSettingsPage() {
            try {
                const response = await fetch('/api/user', { credentials: 'include' });
                if (response.ok) {
                    currentLoggedInUserConfig = await response.json();
                } else {
                    currentLoggedInUserConfig = null;
                }
            } catch (error) {
                console.error('Auth check failed on settings page:', error);
                currentLoggedInUserConfig = null;
            }
            updateSettingsPageNav();
        }

        function updateSettingsPageNav() {
            const authSection = document.getElementById('auth-section-settings');
            const userProfileModal = document.getElementById('user-profile-modal-settings');

            if (currentLoggedInUserConfig) {
                const navProfileImgContainer = createProfileImageElementForSettings(currentLoggedInUserConfig.photo, currentLoggedInUserConfig.name, "w-8 h-8", "text-sm");
                
                authSection.innerHTML = `
                    <button onclick="toggleSettingsProfileModal()" class="nav-profile-button-hover flex items-center space-x-2 p-1 rounded-lg transition-colors">
                        <div id="nav-profile-img-container-settings"></div>
                        <span class="font-medium text-sm">${escapeHtml(currentLoggedInUserConfig.name)}</span>
                    </button>
                `;
                document.getElementById('nav-profile-img-container-settings').appendChild(navProfileImgContainer);

                const modalImgContainer = document.getElementById('modal-profile-img-container-settings');
                modalImgContainer.innerHTML = ''; 
                modalImgContainer.appendChild(createProfileImageElementForSettings(currentLoggedInUserConfig.photo, currentLoggedInUserConfig.name, "w-10 h-10", "text-lg"));
                
                document.getElementById('modal-user-name-settings').textContent = currentLoggedInUserConfig.name;
                document.getElementById('modal-user-email-settings').textContent = currentLoggedInUserConfig.email;
                
                const viewProfileLink = document.getElementById('view-my-profile-link-settings');
                viewProfileLink.href = `/profile.html?id=${currentLoggedInUserConfig.id}`;
                viewProfileLink.classList.add('profile-menu-item'); 

                const settingsLink = document.getElementById('profile-menu-settings-settings');
                // It already has the class profile-menu-item from HTML, so no need to add it via JS.
                // If it needed dynamic content or href, this is where it would be set.
                // settingsLink.href = 'settings.html'; // Already set in HTML

                const logoutBtn = document.getElementById('logout-btn-settings');
                logoutBtn.classList.add('profile-menu-item'); 
                logoutBtn.removeEventListener('click', logoutFromSettingsPage); 
                logoutBtn.addEventListener('click', logoutFromSettingsPage);

            } else {
                authSection.innerHTML = '<a href="/" id="back-to-forum-link" class="hover:underline">Back to Forum</a>'; 
                if(userProfileModal) userProfileModal.classList.add('hidden');
            }
        }
        
        function toggleSettingsProfileModal() {
            const userProfileModal = document.getElementById('user-profile-modal-settings');
            if (!currentLoggedInUserConfig || !userProfileModal) return;
            userProfileModal.classList.toggle('hidden');
        }

        async function logoutFromSettingsPage() {
            try {
                await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
                currentLoggedInUserConfig = null;
                updateSettingsPageNav();
                window.location.href = '/'; 
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }
        
        function escapeHtml(text) {
            if (text === null || typeof text === 'undefined') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('click', (e) => {
            const userProfileModal = document.getElementById('user-profile-modal-settings');
            const authSection = document.getElementById('auth-section-settings');
            if (authSection && userProfileModal && !authSection.contains(e.target) && !userProfileModal.contains(e.target)) {
                userProfileModal.classList.add('hidden');
            }
        });
        
        // Style for toggle switch
        const style = document.createElement('style');
        style.textContent = `
            .toggle-checkbox:checked {
                right: 0;
                border-color: var(--button-bg); /* Use theme variable */
            }
            .toggle-checkbox:checked + .toggle-label {
                background-color: var(--button-bg); /* Use theme variable */
            }
            .radio-dot {
                display: none; /* Hide by default */
            }
            input[type="radio"]:checked + label .radio-dot {
                display: block; /* Show when checked */
            }
            input[type="radio"] + label {
                border-color: var(--input-border);
            }
             input[type="radio"]:checked + label {
                border-color: var(--link-color) !important; /* Ensure this overrides */
                background-color: var(--bg-secondary) !important; /* Lighter background for selection */
            }
            input[type="radio"] + label:hover {
                background-color: var(--bg-secondary);
            }
        `;
        document.head.appendChild(style);

    </script>
</body>
</html>
