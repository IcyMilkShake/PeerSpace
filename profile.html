<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Forum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="theme-loader.js"></script> <!-- THEME LOADER -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <link rel="stylesheet" href="themes.css"> <!-- THEME STYLES -->
    <style>
        /* Profile page specific styles */
        /* Most base styles (body, nav, buttons, modals, inputs) are now in themes.css */

        /* Ensure the main profile card and its header use theme variables if not already covered by Tailwind + themes.css */
        /* #profile-content is styled by themes.css */
        /* .profile-header is styled by themes.css */
        /* #profile-name, #profile-joined-date, #profile-description-view, #profile-description-edit are styled by themes.css */

        /* .button-primary and .button-secondary are defined in themes.css */
        /* Specific buttons like #edit-description-button will use these classes. */

        /* .profile-avatar and related styles are in themes.css */
        
        /* #profile-loading p, #profile-error p are styled by themes.css */
        /* #profile-error a (go to homepage button) is styled by .button-primary in themes.css */

        /* User Profile Modal in nav (#user-profile-modal) is styled by themes.css */
        
        /* .profile-img and .profile-initials are general utility classes in themes.css */

        /* Cropper and Modal Styles (file-upload, crop-image-container, #crop-image, .modal-overlay, etc.) */
        /* are now in themes.css as they are general modal/component styles. */

        /* Styles for text color on specific elements if not covered by general rules in themes.css */
        /* For example, nav h1 text color is handled by 'nav h1' in themes.css */
        nav .text-gray-800 { /* Fallback for Forum title if needed */
            color: var(--text-primary);
        }
        #profile-content .text-gray-800 { /* e.g. Profile Name */
            color: var(--text-primary);
        }
        #profile-content .text-gray-500 { /* e.g. Joined Date */
            color: var(--text-secondary);
        }
        #profile-content .text-gray-700 { /* e.g. "About me" title */
            color: var(--text-primary); 
        }
        #profile-content .text-gray-600 { /* e.g. description view */
            color: var(--text-primary); /* Overridden for better readability in themes.css */
        }
        
        /* Ensure that Tailwind classes like `bg-white` on #profile-content, 
           or `border-b` on .profile-header are effectively themed via themes.css.
           For example, #profile-content { background-color: var(--card-bg); }
           .profile-header { border-bottom-color: var(--border-color); }
        */

    </style>
</head>
<body class="min-h-screen"> 
    <!-- Notification Container (similar to index.html) -->
    <div id="notification-container" class="fixed top-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm sm:max-w-md p-4 space-y-3 z-[100]">
        <!-- Notifications will be dynamically added here -->
    </div>

    <!-- Navigation -->
    <nav class="shadow-md border-b">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <a href="/" class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-lg">F</span>
                    </div>
                    <h1 class="text-2xl font-bold">Forum</h1> <!-- text-gray-800 removed, handled by themes.css -->
                </a>
                <div id="auth-section-profile">
                    <!-- Auth status will be rendered here by JS. Example when logged out:
                         <a href="/" class="text-blue-600 hover:text-blue-700">Back to Forum</a>
                         When logged in, it will be a button to toggle the profile modal.
                    -->
                </div>
            </div>
        </div>
    </nav>

    <!-- User Profile Modal (Dropdown in Nav - structure from index.html) -->
    <!-- ID is changed to user-profile-dropdown-profile to avoid conflict if we reuse user-profile ID from index.html -->
    <div id="user-profile-dropdown-profile" class="hidden fixed top-16 right-4 rounded-lg shadow-lg p-2 border z-50 w-60" style="border-color: var(--border-color);">
        <div class="flex items-center space-x-3 p-2 mb-2 border-b" style="border-bottom-color: var(--border-color);">
            <div id="modal-profile-img-container-profile">
                <!-- Profile image component from createProfileImage will be inserted here. -->
            </div>
            <div>
                <div id="modal-user-name-profile" class="font-medium text-sm"></div>
                <div id="modal-user-email-profile" class="text-xs text-gray-500"></div> <!-- text-gray-500 will be themed -->
            </div>
        </div>
        <nav class="space-y-1">
            <a href="#" id="profile-menu-profile-page" class="profile-menu-item">
                <svg class="w-5 h-5 mr-2 inline" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                Profile
            </a>
            <a href="settings.html" id="profile-menu-settings" class="profile-menu-item">
                <svg class="w-5 h-5 mr-2 inline" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Settings
            </a>
            <hr class="my-1" style="border-top-color: var(--border-color);">
            <button id="logout-btn-profile-page" class="w-full text-left profile-menu-item">
                 <svg class="w-5 h-5 mr-2 inline" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Sign Out
            </button>
        </nav>
    </div>

    <!-- Main Profile Content -->
    <main class="max-w-3xl mx-auto px-4 py-8">
        <div id="profile-loading" class="text-center py-12">
            <p>Loading profile...</p> <!-- text-gray-500 removed -->
        </div>

        <div id="profile-content" class="hidden rounded-lg shadow-lg overflow-hidden"> <!-- bg-white removed -->
            <!-- Profile Header -->
            <div class="profile-header p-6 md:p-8 text-center border-b">
                <div id="profile-avatar-container" class="inline-block rounded-full mx-auto">
                    <!-- Avatar will be loaded here -->
                </div>
                <h2 id="profile-name" class="text-3xl font-bold mt-4"></h2> <!-- text-gray-800 removed -->
                <p id="profile-joined-date" class="text-sm mt-1"></p> <!-- text-gray-500 removed -->
            </div>

            <!-- Profile Details -->
            <div class="p-6 md:p-8">
                <h3 class="text-xl font-semibold mb-3">About Me</h3> <!-- text-gray-700 removed -->
                <div id="profile-description-view" class="whitespace-pre-wrap leading-relaxed"> <!-- text-gray-600 removed -->
                    <!-- Description will be loaded here -->
                </div>
                
                <!-- Edit Description Form (hidden by default) -->
                <div id="edit-description-form" class="hidden mt-4">
                    <textarea id="profile-description-edit" rows="4" 
                              class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 resize-y"
                              placeholder="Tell us about yourself..."></textarea>
                    <div class="mt-3 flex justify-end space-x-2">
                        <button id="cancel-edit-description" class="button-secondary text-sm">
                            Cancel
                        </button>
                        <button id="save-description" class="button-primary text-sm">
                            Save Description
                        </button>
                    </div>
                </div>

                <button id="edit-description-button" class="button-primary hidden mt-4 text-sm">
                    Edit Description
                </button>

                <!-- Change Profile Picture Button - Shown only if it's the current user's profile -->
                <div id="change-picture-section" class="hidden mt-6 pt-6 border-t">
                    <h3 class="text-xl font-semibold mb-3">Profile Picture</h3>
                    <div class="file-upload">
                        <input type="file" id="profile-picture-input-profile-page" accept="image/*" class="hidden"/>
                        <label for="profile-picture-input-profile-page" id="change-profile-picture-button" class="button-primary cursor-pointer inline-block text-sm">
                            Change Profile Picture
                        </label>
                    </div>
                </div>

            </div>
        </div>

        <div id="profile-error" class="hidden text-center py-12">
            <p>Could not load profile. The user may not exist or there was an error.</p>
            <a href="/" id="go-home-error-btn" class="button-primary mt-4 inline-block">Go to Homepage</a>
        </div>
    </main>

    <!-- User Profile Modal (for logged-in user nav on this page) -->
    <!-- THIS IS THE OLD MODAL - IT WILL BE REPLACED BY THE NEW user-profile-dropdown-profile above -->
    <!-- <div id="user-profile-modal" class="hidden fixed top-16 right-4 rounded-lg shadow-lg p-4 border z-50 w-64"> 
        <div class="flex items-center space-x-3 mb-3">
            <div id="modal-profile-img-container" class="profile-img w-10 h-10 rounded-full border-2">
            </div>
            <div>
                <div id="modal-user-name" class="font-medium text-gray-800 text-sm"></div>
                <div id="modal-user-email" class="text-xs text-gray-500"></div>
            </div>
        </div>
        <a id="view-my-profile-link" href="#" class="profile-menu-item"> 
            View My Profile
        </a>
        <a href="settings.html" id="profile-menu-settings-profile" class="profile-menu-item">
            <svg class="w-5 h-5 mr-2 inline" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066 2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            Settings
        </a>
        <hr class="my-1" style="border-top-color: var(--border-color);">
        <button id="logout-btn-profile" class="profile-menu-item"> 
            Sign Out
        </button>
    </div> -->

    <!-- Image Cropper Modal (Copied from index.html) -->
    <div id="crop-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-[60] p-4"> <!-- Ensure z-index is higher than nav modal if needed -->
        <div class="bg-white rounded-lg crop-modal-content max-w-4xl w-full max-h-[95vh] overflow-hidden">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Crop Profile Picture</h3>
                    <button id="crop-cancel" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="crop-image-container mb-4">
                    <img id="crop-image" />
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="crop-cancel-btn" class="px-4 py-2 hover:text-gray-800 transition-colors">
                        Cancel
                    </button>
                    <button id="crop-save" class="px-6 py-2 rounded-lg font-medium transition-colors">
                        Save Picture
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Progress Modal (Copied from index.html) -->
    <div id="upload-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-[70]">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Uploading Profile Picture</h3>
            <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                <div id="upload-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p class="text-sm text-gray-600 text-center">Please wait...</p>
        </div>
    </div>


    <script>
        let currentLoggedInUser = null;
        let profileUserId = null; // To store the ID of the profile being viewed
        let cropper = null; // For profile picture cropping

        // Get initials from name (Standardized - Copied from index.html)
        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
        }
        
        // Create profile image element with fallback (Standardized - Copied from index.html)
        // Added borderClass parameter for optional borders (e.g., for modal profile image)
        function createProfileImage(photoUrl, name, size = "w-10 h-10", textClass = "text-sm", borderClass = "") {
            const container = document.createElement('div');
            container.className = `profile-img ${size} ${borderClass} rounded-full flex items-center justify-center overflow-hidden`;
            container.style.backgroundColor = 'var(--input-field-bg)'; // Apply theme variable
            
            if (borderClass && borderClass.includes('border')) { 
                container.style.borderColor = 'var(--border-color-medium)';
            }
            
            if (photoUrl && photoUrl.trim() && photoUrl !== '/default-profile.png') {
                const img = document.createElement('img');
                img.className = 'w-full h-full object-cover'; 
                img.alt = name || 'Profile';
                
                img.onerror = function() {
                    container.innerHTML = `<span class="profile-initials ${textClass} font-semibold" style="color: var(--text-secondary);">${getInitials(name)}</span>`;
                };
                img.src = photoUrl + '?t=' + Date.now(); // Cache busting
                container.appendChild(img);
            } else {
                container.innerHTML = `<span class="profile-initials ${textClass} font-semibold" style="color: var(--text-secondary);">${getInitials(name)}</span>`;
            }
            return container;
        }

        // --- CropperJS Functions (Copied and adapted from index.html) ---
        function initializeCropper(imageElement) {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            cropper = new Cropper(imageElement, {
                aspectRatio: 1, viewMode: 1, dragMode: 'move', autoCropArea: 0.8,
                restore: false, guides: true, center: true, highlight: false,
                cropBoxMovable: true, cropBoxResizable: true, toggleDragModeOnDblclick: false,
                responsive: true, checkOrientation: false, modal: true, background: true,
                minContainerWidth: 200, minContainerHeight: 200,
            });
        }

        function handleProfilePictureSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            event.target.value = ''; // Reset file input

            if (!file.type.startsWith('image/')) {
                showNotification('Please select an image file', 'warning'); return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showNotification('Image too large (max 5MB)', 'warning'); return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const cropImage = document.getElementById('crop-image');
                if (cropper) cropper.destroy();
                cropImage.src = e.target.result;
                document.getElementById('crop-modal').classList.remove('hidden');
                // User profile modal in nav might be open, ensure it's hidden
                const navUserModal = document.getElementById('user-profile-modal');
                if(navUserModal) navUserModal.classList.add('hidden');

                cropImage.onload = () => setTimeout(() => initializeCropper(cropImage), 100);
            };
            reader.readAsDataURL(file);
        }

        async function uploadCroppedImage() {
            if (!cropper) { showNotification('Cropper not initialized.', 'error'); return; }
            const canvas = cropper.getCroppedCanvas({ width: 300, height: 300, imageSmoothingEnabled: true, imageSmoothingQuality: 'high' });
            if (!canvas) { showNotification('Failed to crop image.', 'error'); return; }

            return new Promise((resolve, reject) => {
                canvas.toBlob(async (blob) => {
                    if (!blob) { reject(new Error('Blob creation failed')); return; }
                    const formData = new FormData();
                    formData.append('profilePicture', blob, 'profile.png');
                    
                    const uploadModal = document.getElementById('upload-modal');
                    const progressBar = document.getElementById('upload-progress');
                    uploadModal.classList.remove('hidden');
                    progressBar.style.width = '0%';

                    const xhr = new XMLHttpRequest();
                    xhr.upload.onprogress = (e) => {
                        if (e.lengthComputable) progressBar.style.width = (e.loaded / e.total) * 100 + '%';
                    };
                    xhr.onload = () => {
                        uploadModal.classList.add('hidden');
                        if (xhr.status === 200) resolve(JSON.parse(xhr.responseText));
                        else reject(new Error(`Upload failed: ${xhr.statusText}`));
                    };
                    xhr.onerror = () => {
                        uploadModal.classList.add('hidden');
                        reject(new Error('Upload network error'));
                    };
                    xhr.open('POST', '/api/user/profile-picture');
                    // Assuming isAuthenticated middleware on server handles auth via session cookie
                    xhr.send(formData);
                }, 'image/png', 0.9);
            });
        }
        // --- End CropperJS Functions ---


        async function checkAuthStatusForProfilePage() {
            try {
                const response = await fetch('/api/user', { credentials: 'include' });
                if (response.ok) {
                    currentLoggedInUser = await response.json();
                } else {
                    currentLoggedInUser = null;
                }
            } catch (error) {
                console.error('Auth check failed on profile page:', error);
                currentLoggedInUser = null;
            }
            updateProfilePageNav(); 
        }

        function updateProfilePageNav() {
            const authSection = document.getElementById('auth-section-profile');
            // Use the new dropdown ID
            const userProfileDropdown = document.getElementById('user-profile-dropdown-profile'); 

            if (currentLoggedInUser) {
                const navProfileImg = createProfileImage(currentLoggedInUser.photo, currentLoggedInUser.name, "w-8 h-8", "text-xs");
                
                // Standardized button structure from index.html
                authSection.innerHTML = `
                    <button onclick="toggleProfileDropdown()" class="nav-profile-button-hover flex items-center space-x-2 p-1 rounded-lg transition-colors">
                        <div id="nav-profile-img-container-profile-page"></div> <!-- Unique ID for nav image container -->
                        <span class="font-medium text-sm">${escapeHtml(currentLoggedInUser.name)}</span>
                    </button>
                `;
                document.getElementById('nav-profile-img-container-profile-page').appendChild(navProfileImg);

                // Update new user profile dropdown modal
                const modalImgContainer = document.getElementById('modal-profile-img-container-profile');
                modalImgContainer.innerHTML = ''; 
                modalImgContainer.appendChild(createProfileImage(currentLoggedInUser.photo, currentLoggedInUser.name, "w-10 h-10", "text-base", "border-2"));
                
                document.getElementById('modal-user-name-profile').textContent = currentLoggedInUser.name;
                document.getElementById('modal-user-email-profile').textContent = currentLoggedInUser.email;
                
                // Update links in the new dropdown
                const profileMenuLink = document.getElementById('profile-menu-profile-page');
                if (profileMenuLink) {
                    profileMenuLink.href = `profile.html?id=${currentLoggedInUser.id}`;
                }
                // Settings link 'profile-menu-settings-profile-page' href is already correct in HTML

                const logoutBtn = document.getElementById('logout-btn-profile-page');
                logoutBtn.removeEventListener('click', logoutFromProfilePage); 
                logoutBtn.addEventListener('click', logoutFromProfilePage);

                // Ensure dropdown is hidden initially if user just logged in, or shown if it was already toggled (though typically hidden on load)
                // userProfileDropdown.classList.add('hidden'); // Or manage visibility based on previous state if needed

            } else {
                authSection.innerHTML = '<a href="/" id="back-to-forum-link-profile" class="hover:underline">Back to Forum</a>'; // Added ID for consistency
                if (userProfileDropdown) userProfileDropdown.classList.add('hidden');
            }
        }
        
        // Renamed and updated to match index.html's toggleUserProfile
        function toggleProfileDropdown() {
            const userProfileDropdown = document.getElementById('user-profile-dropdown-profile');
            if (!currentLoggedInUser || !userProfileDropdown) return;
            userProfileDropdown.classList.toggle('hidden');
        }

        async function logoutFromProfilePage() {
            try {
                await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
                currentLoggedInUser = null;
                updateProfilePageNav(); 
                // Redirect to home after logout
                window.location.href = '/'; 
            } catch (error) {
                console.error('Logout failed:', error);
                showNotification('Logout failed. Please try again.', 'error');
            }
        }
        
        function escapeHtml(text) {
            if (text === null || typeof text === 'undefined') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close dropdown when clicking outside - updated to new IDs
        document.addEventListener('click', (e) => {
            const userProfileDropdown = document.getElementById('user-profile-dropdown-profile');
            const authSection = document.getElementById('auth-section-profile');
            // Check if elements exist before trying to access contains
            if (authSection && userProfileDropdown && 
                !authSection.contains(e.target) && 
                !userProfileDropdown.contains(e.target)) {
                userProfileDropdown.classList.add('hidden');
            }
        });

        function getUserIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
        }

        async function loadProfileData() {
            profileUserId = getUserIdFromUrl();
            if (!profileUserId) {
                displayProfileError("No user ID provided in the URL.");
                return;
            }

            document.getElementById('profile-loading').classList.remove('hidden');
            document.getElementById('profile-content').classList.add('hidden');
            document.getElementById('profile-error').classList.add('hidden');

            try {
                const response = await fetch(`/api/users/${profileUserId}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `Error ${response.status}` }));
                    throw new Error(errorData.error || errorData.message || `Failed to load profile: ${response.status}`);
                }
                const profileData = await response.json();
                
                renderProfileData(profileData);

                document.getElementById('profile-loading').classList.add('hidden');
                document.getElementById('profile-content').classList.remove('hidden');

            } catch (error) {
                console.error("Failed to load profile data:", error);
                displayProfileError(error.message);
            }
        }

        function renderProfileData(profile) {
            // Avatar
            const avatarContainer = document.getElementById('profile-avatar-container');
            avatarContainer.innerHTML = ''; // Clear previous
            // CORRECTED: Call the standardized createProfileImage function
            const avatarElement = createProfileImage(profile.photo, profile.name, "profile-avatar", "text-5xl");
            avatarContainer.appendChild(avatarElement);

            // Name and Join Date
            document.getElementById('profile-name').textContent = escapeHtml(profile.name);
            document.getElementById('profile-joined-date').textContent = `Joined on ${formatDate(profile.createdAt)}`;

            // Description
            const descriptionView = document.getElementById('profile-description-view');
            const descriptionEditInput = document.getElementById('profile-description-edit');
            descriptionView.textContent = profile.description || 'No description provided.';
            descriptionEditInput.value = profile.description || '';

            // Edit button visibility
            const editButton = document.getElementById('edit-description-button');
            if (currentLoggedInUser && currentLoggedInUser.id === profile.id) {
                editButton.classList.remove('hidden');
                editButton.onclick = () => {
                    descriptionView.classList.add('hidden');
                    editButton.classList.add('hidden');
                    document.getElementById('edit-description-form').classList.remove('hidden');
                    descriptionEditInput.focus();
                };

                // Show change profile picture section
                document.getElementById('change-picture-section').classList.remove('hidden');
                document.getElementById('profile-picture-input-profile-page').addEventListener('change', handleProfilePictureSelect);

            } else {
                editButton.classList.add('hidden');
                document.getElementById('change-picture-section').classList.add('hidden');
            }
        }

        function displayProfileError(message) {
            document.getElementById('profile-loading').classList.add('hidden');
            document.getElementById('profile-content').classList.add('hidden');
            const errorElement = document.getElementById('profile-error');
            errorElement.classList.remove('hidden');
            errorElement.querySelector('p').textContent = message || "Could not load profile.";
        }
        
        async function saveDescription() {
            const newDescription = document.getElementById('profile-description-edit').value;
            const saveButton = document.getElementById('save-description');
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';

            try {
                const response = await fetch('/api/user/description', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ description: newDescription })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Failed to save description.'}));
                    throw new Error(errorData.error || errorData.message);
                }
                const result = await response.json();

                if (result.success) {
                    document.getElementById('profile-description-view').textContent = result.description || 'No description provided.';
                    // Update currentLoggedInUser if it's their own profile, for consistency
                    if (currentLoggedInUser && currentLoggedInUser.id === profileUserId) {
                         currentLoggedInUser.description = result.description;
                    }
                    cancelEditDescription(); // Hide form, show view
                } else {
                    alert('Failed to save description: ' + (result.error || 'Unknown error'));
                }

            } catch (error) {
                console.error("Error saving description:", error);
                alert('Error saving description: ' + error.message);
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Save Description';
            }
        }

        function cancelEditDescription() {
            document.getElementById('edit-description-form').classList.add('hidden');
            document.getElementById('profile-description-view').classList.remove('hidden');
            document.getElementById('edit-description-button').classList.remove('hidden');
            // Optionally reset textarea content if needed:
            // document.getElementById('profile-description-edit').value = document.getElementById('profile-description-view').textContent;
        }

        // Event Listeners for description editing
        document.getElementById('save-description').addEventListener('click', saveDescription);
        document.getElementById('cancel-edit-description').addEventListener('click', cancelEditDescription);

        // Event Listeners for Cropper Modal
        document.getElementById('crop-save').addEventListener('click', async () => {
            try {
                const result = await uploadCroppedImage(); // This now uses the XHR upload
                if (result && result.success) {
                    if (currentLoggedInUser && currentLoggedInUser.id === profileUserId) {
                        currentLoggedInUser.photo = result.photo; // Update local cache for logged-in user
                    }
                    // Re-render the main profile avatar on this page
                    const avatarContainer = document.getElementById('profile-avatar-container');
                    avatarContainer.innerHTML = ''; // Clear previous
                    const newAvatar = createProfileImageElement(result.photo, document.getElementById('profile-name').textContent, "profile-avatar", "text-5xl");
                    avatarContainer.appendChild(newAvatar);
                    
                    // Also update the avatar in the nav modal if it's the current user's profile
                    if (currentLoggedInUser && currentLoggedInUser.id === profileUserId) {
                         updateProfilePageNav(); // This will refresh the nav modal with new pic
                    }

                    document.getElementById('crop-modal').classList.add('hidden');
                    if (cropper) { cropper.destroy(); cropper = null; }
                    showNotification('Profile picture updated successfully!', 'success');
                } else {
                    showNotification(result.error || 'Failed to update profile picture.', 'error');
                }
            } catch (error) {
                console.error('Error updating profile picture:', error);
                showNotification(`Failed to update profile picture: ${error.message}`, 'error');
                document.getElementById('crop-modal').classList.add('hidden');
                if (cropper) { cropper.destroy(); cropper = null; }
            }
        });

        function closeCropModal() {
            document.getElementById('crop-modal').classList.add('hidden');
            if (cropper) { cropper.destroy(); cropper = null; }
        }
        document.getElementById('crop-cancel').addEventListener('click', closeCropModal);
        document.getElementById('crop-cancel-btn').addEventListener('click', closeCropModal);
        window.addEventListener('resize', () => { if (cropper) cropper.resize(); });


        // --- Notification System (Full version from index.html) ---
        const notificationContainerProfile = document.getElementById('notification-container');

        function showNotification(message, type = 'info', duration = 3000) {
            if (!notificationContainerProfile) { // Check if container exists on this page
                console.warn("Notification container not found on profile.html. Falling back to alert.");
                alert(`${type.toUpperCase()}: ${message}`);
                return;
            }

            const notificationId = `notif-profile-${Date.now()}`;
            const notification = document.createElement('div');
            notification.id = notificationId;
            // Basic classes, assuming Tailwind is available or similar global styles for notifications
            notification.className = `notification notification-${type}`; // Relies on global styles for .notification, .notification-type
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            notification.appendChild(messageSpan);

            const closeButton = document.createElement('button');
            closeButton.className = 'notification-close-btn'; // Relies on global styles
            closeButton.innerHTML = '&times;';
            closeButton.onclick = () => {
                notification.classList.remove('notification-visible'); // Relies on global styles
                setTimeout(() => notification.remove(), 300); 
            };
            notification.appendChild(closeButton);

            notificationContainerProfile.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('notification-visible'); // Relies on global styles
            }, 50); 

            if (duration > 0) {
                setTimeout(() => {
                    if (document.getElementById(notificationId)) {
                        notification.classList.remove('notification-visible');
                        setTimeout(() => notification.remove(), 300);
                    }
                }, duration);
            }
        }
        // --- End Notification System ---

        // Modified Initial calls
        document.addEventListener('DOMContentLoaded', async () => {
            // theme-loader.js already applies theme by the time DOMContentLoaded fires
            await checkAuthStatusForProfilePage(); 
            await loadProfileData(); 
        });

    </script>
</body>
</html>
